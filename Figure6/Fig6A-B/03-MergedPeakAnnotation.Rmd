---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
date()
setwd("/Users/magalhae/Desktop/Atshuhiro/CutandRUN/")
library(tidyverse)
library(ChIPQC)
library(ChIPseeker)
library(clusterProfiler)
library(AnnotationDbi)
library(AnnotationHub)
library(ensembldb)
library(Rsamtools)
library(Signac)
#library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(TxDb.Mmusculus.UCSC.mm10.knownGene)
#library(TxDb.Mmusculus.UCSC.mm39.knownGene)
library(ChIPpeakAnno)
library(BSgenome.Mmusculus.UCSC.mm10)
```


```{r}
txdb <- TxDb.Mmusculus.UCSC.mm10.knownGene
annoDataTxDb <- toGRanges(TxDb.Mmusculus.UCSC.mm10.knownGene)
head(annoDataTxDb, n=2)
```

```{r}
#Load data
samplefiles <- list.files("./Merged/CutRun/peaks", pattern= ".bed", full.names=T)

names(samplefiles) <- basename(gsub(samplefiles, pattern = ".merged.seacr.peaks.stringent.bed", replacement=""))
```

```{r}
peakAnnoList <- lapply(samplefiles, annotatePeak, TxDb=txdb, 
                       tssRegion=c(-2000, 1000), verbose=TRUE, annoDb="org.Mm.eg.db")
```
```{r}
plotAnnoBar(peakAnnoList)
ggsave("MergedPeaks_plotAnnoBar.pdf")
plotDistToTSS(peakAnnoList, title="Distribution of transcription factor-binding loci \n relative to TSS")
ggsave("MergedPeaks_plotDistToTSS.pdf")
```


```{r}
annot_peaks <- lapply(peakAnnoList, as.data.frame)
```

```{r}
library(openxlsx)
# create workbook
wb <- createWorkbook()

#Iterate the same way as PavoDive, slightly different (creating an anonymous function inside Map())
Map(function(data, nameofsheet){     

    addWorksheet(wb, nameofsheet)
    writeData(wb, nameofsheet, data)

}, annot_peaks, names(annot_peaks))

## Save workbook to excel file 
saveWorkbook(wb, file = "Peak_annotation_MergedPeaks.xlsx", overwrite = TRUE)
```

```{r}
Adult_Nr1i3 <- toGRanges("./Merged/CutRun/peaks/Adult_Nr1i3.merged.seacr.peaks.stringent.bed")
Adult_Nfix <- toGRanges("./Merged/CutRun/peaks/Adult_Nfix.merged.seacr.peaks.stringent.bed")
Adult_Hnf4a <- toGRanges("./Merged/CutRun/peaks/Adult_Hnf4a.merged.seacr.peaks.stringent.bed")

Adult_H3K4me3 <- toGRanges("/Users/magalhae/Desktop/Atshuhiro/CutandRUN/Merged/CutRun/peaks/Adult_H3K4me3.merged.seacr.peaks.stringent.bed")
E15_H3K4me3 <- toGRanges("/Users/magalhae/Desktop/Atshuhiro/CutandRUN/Merged/CutRun/peaks/E15_H3K4me3.merged.seacr.peaks.stringent.bed")
```
```{r}
library(Vennerable)
venn_cnt2venn <- function(venn_cnt){
 n <- which(colnames(venn_cnt)=="Counts") - 1
 SetNames=colnames(venn_cnt)[1:n]
 Weight=venn_cnt[,"Counts"]
 names(Weight) <- apply(venn_cnt[,1:n], 1, paste, collapse="")
 Venn(SetNames=SetNames, Weight=Weight)
 }
```

```{r}
overlapping_peaks <- findOverlapsOfPeaks(Adult_Nr1i3, 
                                         Adult_Nfix, 
                                         Adult_Hnf4a, 
                                         connectedPeaks = "keepAll")
mean_peak_width <- mean(width(unlist(GRangesList(overlapping_peaks[["all.peaks"]]))))

total_binding_sites <- length(BSgenome.Mmusculus.UCSC.mm10[["chr2"]]) * 0.03 / mean_peak_width

```
```{r fig.height=6, fig.width=6}
pdf("overlapping_peaks_CutRun_MatHep_Venn.pdf")
venn1 <- makeVennDiagram(overlapping_peaks, 
                         totalTest = total_binding_sites, 
                         connectedPeaks = "keepAll", 
                         fill = c("#CC79A7", "#56B4E9", "#F0E442"),
                         col = c("#D55E00", "#0072B2", "#E69F00"),
                         cat.col = c("#D55E00", "#0072B2", "#E69F00"),
                         imagetype = "svg", scaled = TRUE, euler.d = TRUE
                         )
dev.off()
pdf("overlapping_peaks_CutRun_MatHep_Euler.pdf")
v1 <- venn_cnt2venn(venn1$vennCounts)
plot(v1)
dev.off()
```


```{r}
overlapping_peaks_H3K4me3 <- findOverlapsOfPeaks(Adult_H3K4me3,
                                          E15_H3K4me3,
                                          Adult_Nr1i3, 
                                         Adult_Nfix, 
                                         Adult_Hnf4a, 
                                         connectedPeaks = "keepAll")
mean_peak_width_H3K4me3 <- mean(width(unlist(GRangesList(overlapping_peaks_H3K4me3[["all.peaks"]]))))

total_binding_sites_H3K4me3 <- length(BSgenome.Mmusculus.UCSC.mm10[["chr2"]]) * 0.03 / mean_peak_width_H3K4me3

```
```{r fig.height=6, fig.width=6}
pdf("overlapping_peaks_CutRun_MatHep_H3K4me3_Venn.pdf")
venn1_H3K4me3 <- makeVennDiagram(overlapping_peaks_H3K4me3, 
                         totalTest = total_binding_sites_H3K4me3, 
                         connectedPeaks = "keepAll", 
                         fill = c("#252525", "#999999","#CC79A7", "#56B4E9", "#F0E442"),
                         col = c("#252525", "#999999","#D55E00", "#0072B2", "#E69F00"),
                         cat.col = c("#252525", "#999999", "#D55E00", "#0072B2", "#E69F00"),
                         imagetype = "svg", scaled = TRUE, euler.d = TRUE
                         )
dev.off()
pdf("overlapping_peaks_CutRun_MatHep_H3K4me3Euler.pdf")
v1_H3K4me3 <- venn_cnt2venn(venn1_H3K4me3$vennCounts)
plot(v1_H3K4me3)
dev.off()
```

```{r}
overlapping_peaks_H3K4me3 <- findOverlapsOfPeaks(Adult_H3K4me3,
                                          E15_H3K4me3,
                                          Adult_Nfix,
                                          Adult_Hnf4a,
                                         connectedPeaks = "keepAll")
mean_peak_width_H3K4me3 <- mean(width(unlist(GRangesList(overlapping_peaks_H3K4me3[["all.peaks"]]))))

total_binding_sites_H3K4me3 <- length(BSgenome.Mmusculus.UCSC.mm10[["chr2"]]) * 0.03 / mean_peak_width_H3K4me3

```
```{r fig.height=6, fig.width=6}
pdf("overlapping_peaks_CutRun_MatHep_H3K4me3_Nr1i3_Venn.pdf")
venn1_H3K4me3 <- makeVennDiagram(overlapping_peaks_H3K4me3, 
                         totalTest = total_binding_sites_H3K4me3, 
                         connectedPeaks = "keepAll", 
                         fill = c("#252525", "#999999","#CC79A7", "#56B4E9"),
                         col = c("#252525", "#999999","#D55E00", "#0072B2"),
                         cat.col = c("#252525", "#999999", "#D55E00", "#0072B2"),
                         imagetype = "svg", scaled = TRUE, euler.d = TRUE
                         )
dev.off()
pdf("overlapping_peaks_CutRun_MatHep_H3K4me3_Nfix_Hnf4a_Euler.pdf")
v1_H3K4me3 <- venn_cnt2venn(venn1_H3K4me3$vennCounts)
plot(v1_H3K4me3)
dev.off()
```


```{r}
overlapping_peaks_H3K4me3 <- findOverlapsOfPeaks(Adult_H3K4me3,
                                          E15_H3K4me3,
                                          Adult_Nr1i3, 
                                         connectedPeaks = "keepAll")
mean_peak_width_H3K4me3 <- mean(width(unlist(GRangesList(overlapping_peaks_H3K4me3[["all.peaks"]]))))

total_binding_sites_H3K4me3 <- length(BSgenome.Mmusculus.UCSC.mm10[["chr2"]]) * 0.03 / mean_peak_width_H3K4me3

```
```{r fig.height=6, fig.width=6}
#pdf("overlapping_peaks_CutRun_MatHep_H3K4me3_Nr1i3_Venn.pdf")
venn1_H3K4me3 <- makeVennDiagram(overlapping_peaks_H3K4me3, 
                         totalTest = total_binding_sites_H3K4me3, 
                         connectedPeaks = "keepAll", 
                         fill = c("#252525", "#999999","#CC79A7"),
                         col = c("#252525", "#999999","#D55E00"),
                         cat.col = c("#252525", "#999999", "#D55E00"),
                         imagetype = "svg", scaled = TRUE, euler.d = TRUE
                         )
#dev.off()
pdf("overlapping_peaks_CutRun_MatHep_H3K4me3_Nr1i3_Euler.pdf")
v1_H3K4me3 <- venn_cnt2venn(venn1_H3K4me3$vennCounts)
plot(v1_H3K4me3)
dev.off()
```

